name: CI Assignment 6

# íŠ¸ë¦¬ê±° ì„¤ì •
on:
  pull_request:
    # PRì´ ì˜¬ë¼ì™”ì„ ë•Œ, commit pushë  ë•Œ ì‹¤í–‰
    types: [opened, synchronize, reopened]
    paths:
      - "packages/assignment-6/**"

jobs:
  # job1. tsc build ì‹¤í–‰í•œë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê¸´ë‹¤.
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm -F assignment-6 install
      - name: Run TypeScript build
        run: pnpm -F assignment-6 build
        working-directory: packages/assignment-6
        id: tsc-build
      - name: Comment PR on build failure
        if: failure() && steps.job1.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.TOKEN_FOR_CI}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: 'ğŸš¨ TypeScript build failed. Please check the errors and fix them.'
            })

  # job2. eslintë¥¼ ì‹¤í–‰í•œ ë‹¤ìŒì—, eslintì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•  ê²½ìš° reportë¥¼ ì½”ë©˜íŠ¸ì— ë‚¨ê¸´ë‹¤.
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install
      - name: Run ESLint
        id: eslint
        run: pnpm -F assignment-6 lint
      - name: Comment PR with ESLint results
        if: failure() && steps.eslint.outcome=='failure'
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.TOKEN_FOR_CI }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ESLintì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¦¬í¬íŠ¸:\n```json\n' + eslintReport + '\n```'
              })

  # job3. í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³ , ì»¤ë²„ë¦¬ì§€ë¥¼ ì¸¡ì •í•˜ì—¬ ì½”ë©˜íŠ¸ì— ë‚¨ê¸´ë‹¤.
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - name: Install dependencies
        run: |
          cd packages/assignment-6
          pnpm install
          pnpm install -D vitest jsdom @vitest/coverage-v8
      - name: Run tests with coverage
        run: pnpm -F assignment-6 run test
      - name: Extract coverage metrics
        id: coverage
        run: |
          LINE_COVERAGE=$(cat packages/assignment-6/coverage/coverage-summary.json | jq -r '.total.lines.pct')
          BRANCH_COVERAGE=$(cat packages/assignment-6/coverage/coverage-summary.json | jq -r '.total.branches.pct')
          FUNCTION_COVERAGE=$(cat packages/assignment-6/coverage/coverage-summary.json | jq -r '.total.functions.pct')
          STATEMENT_COVERAGE=$(cat packages/assignment-6/coverage/coverage-summary.json | jq -r '.total.statements.pct')
          echo "line_coverage=${LINE_COVERAGE}" >> $GITHUB_OUTPUT
          echo "branch_coverage=${BRANCH_COVERAGE}" >> $GITHUB_OUTPUT
          echo "function_coverage=${FUNCTION_COVERAGE}" >> $GITHUB_OUTPUT
          echo "statement_coverage=${STATEMENT_COVERAGE}" >> $GITHUB_OUTPUT
      - name: Comment PR
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.TOKEN_FOR_CI }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### ì»¤ë²„ë¦¬ì§€ ê²°ê³¼

              * ë¼ì¸ ì»¤ë²„ë¦¬ì§€: ${{steps.coverage.outputs.line_coverage}}%
              * ë¸Œëœì¹˜ ì»¤ë²„ë¦¬ì§€: ${{steps.coverage.outputs.branch_coverage}}%
              * í•¨ìˆ˜ ì»¤ë²„ë¦¬ì§€: ${{steps.coverage.outputs.function_coverage}}%
              * êµ¬ë¬¸ ì»¤ë²„ë¦¬ì§€: ${{steps.coverage.outputs.statement_coverage}}%`
            })

  # job4. lighthouse ci ë¥¼ ì‹¤í–‰í•˜ê³ , ì‹¤í–‰ ê²°ê³¼ë¥¼ ì½”ë©˜íŠ¸ì— ë‚¨ê¸´ë‹¤.
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build project
        run: pnpm -F assignment-6 run build
        working-directory: packages/assignment-6
        id: tsc-build

      - name: Run Lighthouse CI
        run: |
          pnpm -F assignment-6 install @lhci/cli
          pnpm -F assignment-6 lhci
      - name: Format lighthouse score
        id: format_lighthouse_score
        uses: actions/github-script@v3
        with:
          github-token: ${{secrets.TOKEN_FOR_CI}}
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync("/{Github Actions runner directory}/lhci_reports/manifest.json"));
            # commentë¥¼ ë‹´ì„ ë³€ìˆ˜ ì…ë‹ˆë‹¤.
            let comments = "";

            results.forEach((result) => {
              const { summary, jsonPath } = result;
              const { audits } = details;

              const details = JSON.parse(fs.readFileSync(jsonPath));
              const formatResult = (res) => Math.round(res * 100);

              Object.keys(summary).forEach(
                (key) => (summary[key] = formatResult(summary[key]))
              );

              const score = (res) => (res >= 90 ? "ğŸŸ¢" : res >= 50 ? "ğŸŸ " : "ğŸ”´");

              const comment = [
                `âš¡ï¸ Lighthouse report!`,
                `| ì¹´í…Œê³ ë¦¬ | ì ìˆ˜ |`,
                `| --- | --- |`,
                `| ${score(summary.performance)} Performance | ${summary.performance} |`,
                { ... }
              ].join("\n");

            });
            return comments;
      - name: Comment PR
        uses: actions/github-script@v6
        with:
          GITHUB_TOKEN: ${{ secrets.TOKEN_FOR_CI }}
          script: |
            const comments = ${{ steps.format_lighthouse_score.outputs.result }};
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comments
            })

  # job5.  PRì´ openë  ë•Œë§Œ ì‹¤í–‰ë˜ê³ , íŒ€ì› ì¤‘ í•œ ëª…ì„ ëœë¤ìœ¼ë¡œ ì„ ì •í•˜ì—¬ ë¦¬ë·°ì–´ë¥¼ ì§€ì •í•œ ë‹¤ìŒì— ì½”ë©˜íŠ¸ì— ë©˜ì…˜í•˜ì—¬ ì˜¬ë¦°ë‹¤.
  # ì‹¤ì œë¡œ PRì— ë¦¬ë·°ì–´ë¡œ ì§€ì •ë„ ë˜ì–´ì•¼í•œë‹¤.
  assign_reviewer:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - uses: actions/checkout@v4
      - name: Random Reviewer Assignment
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.TOKEN_FOR_CI }}
          script: |
            const teamMembers = ['Raihyul', 'horang-e', 'lucettin5'];
            const reviewer = teamMembers[Math.floor(Math.random() * teamMembers.length)];

            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              reviewers: [reviewer]
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `@${reviewer} has been randomly assigned to review this PR. Please take a look when you have a chance!`
            });
