name: CI Assignment 6

# íŠ¸ë¦¬ê±° ì„¤ì •
on:
  pull_request:
    # PRì´ ì˜¬ë¼ì™”ì„ ë•Œ, commit pushë  ë•Œ ì‹¤í–‰
    types: [opened, synchronize, reopened]
    paths:
      - "packages/assignment-6/**"

jobs:
  # job1. tsc build ì‹¤í–‰í•œë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê¸´ë‹¤.
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm -F assignment-6 install
      - name: Run TypeScript build
        run: pnpm -F assignment-6 build
        working-directory: packages/assignment-6
        id: tsc-build
      - name: Comment PR on build failure
        if: failure() && steps.job1.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.TOKEN_FOR_CI}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: 'ğŸš¨ TypeScript build failed. Please check the errors and fix them.'
            })

  # job2. eslintë¥¼ ì‹¤í–‰í•œ ë‹¤ìŒì—, eslintì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•  ê²½ìš° reportë¥¼ ì½”ë©˜íŠ¸ì— ë‚¨ê¸´ë‹¤.
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build project
        run: pnpm -F assignment-6 run build
        working-directory: packages/assignment-6
        id: tsc-build
      - name: Run ESLint
        run: npx eslint . --ext .js,.jsx,.ts,.tsx --format json --output-file eslint-report.json
      - name: Comment PR with ESLint results
        if: failure()
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.TOKEN_FOR_CI }}
          script: |
            const fs = require('fs');
            const eslintReport = JSON.parse(fs.readFileSync('eslint-report.json', 'utf8'));
            const errorCount = eslintReport.reduce((acc, file) => acc + file.errorCount, 0);
            const warningCount = eslintReport.reduce((acc, file) => acc + file.warningCount, 0);

            let comment = `## ESLint Results\n\n`;
            comment += `- Errors: ${errorCount}\n`;
            comment += `- Warnings: ${warningCount}\n\n`;

            if (errorCount > 0 || warningCount > 0) {
              comment += 'Please fix the following issues:\n\n';
              eslintReport.forEach(file => {
                if (file.messages.length > 0) {
                  comment += `### ${file.filePath}\n`;
                  file.messages.forEach(message => {
                    comment += `- ${message.message} (${message.line}:${message.column})\n`;
                  });
                  comment += '\n';
                }
              });
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: comment
            });

  # job3. í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³ , ì»¤ë²„ë¦¬ì§€ë¥¼ ì¸¡ì •í•˜ì—¬ ì½”ë©˜íŠ¸ì— ë‚¨ê¸´ë‹¤.
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build project
        run: pnpm -F assignment-6 run build
        working-directory: packages/assignment-6
        id: tsc-build
      - name: Run tests with coverage
        # í…ìŠ¤íŠ¸ í˜•ì‹ê³¼ ìš”ì•½ í˜•ì‹ ì„ íƒ
        run: pnpm -F assignment-6 test -- --coverage --coverageReporters="text" --coverageReporters="text-summary" > coverage.txt
      - name: Extract coverage metrics
        id: coverage
        # All filesëŠ” ì»¤ë²„ë¦¬ì§€ ìš”ì•½, awkëŠ” í…ìŠ¤íŠ¸ ì²˜ë¦¬, print $3ëŠ” 3ë²ˆì§¸ í•„ë“œ ì¶œë ¥
        run: |
          LINE_COVERAGE=$(grep "All files" coverage.txt | awk '{print $3}')
          BRANCH_COVERAGE=$(grep "All files" coverage.txt | awk '{print $4}')
          FUNCTION_COVERAGE=$(grep "All files" coverage.txt | awk '{print $5}')
          STATEMENT_COVERAGE=$(grep "All files" coverage.txt | awk '{print $6}')
          echo "line_coverage=$LINE_COVERAGE" >> $GITHUB_OUTPUT
          echo "branch_coverage=$BRANCH_COVERAGE" >> $GITHUB_OUTPUT
          echo "function_coverage=$FUNCTION_COVERAGE" >> $GITHUB_OUTPUT
          echo "statement_coverage=$STATEMENT_COVERAGE" >> $GITHUB_OUTPUT
      - name: Comment PR
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.TOKEN_FOR_CI }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: `### í…ŒìŠ¤íŠ¸ ì„±ê³µ

              * ë¼ì¸ ì»¤ë²„ë¦¬ì§€: ${lineCoverage}
              * ë¸Œëœì¹˜ ì»¤ë²„ë¦¬ì§€: ${branchCoverage}
              * í•¨ìˆ˜ ì»¤ë²„ë¦¬ì§€: ${functionCoverage}
              * êµ¬ë¬¸ ì»¤ë²„ë¦¬ì§€: ${statementCoverage}`
            })

  # job4. lighthouse ci ë¥¼ ì‹¤í–‰í•˜ê³ , ì‹¤í–‰ ê²°ê³¼ë¥¼ ì½”ë©˜íŠ¸ì— ë‚¨ê¸´ë‹¤.
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build project
        run: pnpm -F assignment-6 run build
        working-directory: packages/assignment-6
        id: tsc-build

      - name: Run Lighthouse CI
        run: |
          pnpm -F assignment-6 add -g @lhci/cli
          lhci autorun
      - name: Generate and Upload Lighthouse Report
        env:
          github-token: ${{secrets.TOKEN_FOR_CI }}
        run: |
          lhci collect --additive
          lhci upload --target=filesystem --outputDir=./lighthouse-reports
          lhci upload --target=temporary-public-storage
      - name: Format lighthouse score
        id: format_lighthouse_score
        uses: actions/github-script@v3
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync("/{Github Actions runner directory}/lhci_reports/manifest.json"));
            # commentë¥¼ ë‹´ì„ ë³€ìˆ˜ ì…ë‹ˆë‹¤.
            let comments = "";

            results.forEach((result) => {
              const { summary, jsonPath } = result;
              const { audits } = details;

              const details = JSON.parse(fs.readFileSync(jsonPath));
              const formatResult = (res) => Math.round(res * 100);

              Object.keys(summary).forEach(
                (key) => (summary[key] = formatResult(summary[key]))
              );

              const score = (res) => (res >= 90 ? "ğŸŸ¢" : res >= 50 ? "ğŸŸ " : "ğŸ”´");

              const comment = [
                `âš¡ï¸ Lighthouse report!`,
                `| ì¹´í…Œê³ ë¦¬ | ì ìˆ˜ |`,
                `| --- | --- |`,
                `| ${score(summary.performance)} Performance | ${summary.performance} |`,
                { ... }
              ].join("\n");

            });
            return comments;
      - name: Comment PR
        uses: actions/github-script@v6
        with:
          GITHUB_TOKEN: ${{ secrets.TOKEN_FOR_CI }}
          script: |
            const comments = ${{ steps.format_lighthouse_score.outputs.result }};
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comments
            })

  # job5.  PRì´ openë  ë•Œë§Œ ì‹¤í–‰ë˜ê³ , íŒ€ì› ì¤‘ í•œ ëª…ì„ ëœë¤ìœ¼ë¡œ ì„ ì •í•˜ì—¬ ë¦¬ë·°ì–´ë¥¼ ì§€ì •í•œ ë‹¤ìŒì— ì½”ë©˜íŠ¸ì— ë©˜ì…˜í•˜ì—¬ ì˜¬ë¦°ë‹¤.
  # ì‹¤ì œë¡œ PRì— ë¦¬ë·°ì–´ë¡œ ì§€ì •ë„ ë˜ì–´ì•¼í•œë‹¤.
  assign_reviewer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Random Reviewer Assignment
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.TOKEN_FOR_CI }}
          script: |
            const teamMembers = ['Raihyul', 'horang-e', 'lucettin5'];
            const reviewer = teamMembers[Math.floor(Math.random() * teamMembers.length)];

            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              reviewers: [reviewer]
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `@${reviewer} has been randomly assigned to review this PR. Please take a look when you have a chance!`
            });
