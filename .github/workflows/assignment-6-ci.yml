name: CI Assignment 6

on:
  pull_request:
    types:
      [opened, synchronize]
    paths:
      - 'packages/assignment-6/**'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Run build
        id: build
        run: |
          pnpm -F assignment-6 build > build.log 2>&1
          exit_code=$?
          echo "build_exit_code=$exit_code" >> $GITHUB_OUTPUT

      - name: Comment build results
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.TOKEN_FOR_CI }}
          script: |
            const fs = require('fs');
            const buildStatus = '${{ steps.build.outputs.build_exit_code }}' === '0' ? 'Successed' : 'Failed';
            const buildEmoji = buildStatus === 'Successed' ? 'âœ…' : 'âŒ';
            const buildLog = fs.readFileSync('build.log', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### Build ${buildStatus} ${buildEmoji}\n\`\`\`\n${buildLog}\n\`\`\``
            });

      - name: Check build result
        if: steps.build.outputs.build_exit_code != '0'
        run: exit 1

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies.
        run: pnpm install 

      - name: run lint
        run: |
          pnpm -F assignment-6 lint 2>&1 | tee lint.log
          exit ${PIPESTATUS[0]}
      - name: Comment on PR if lint fails
        if: failure()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.TOKEN_FOR_CI }}
          script: |
            const fs = require('fs');
            const log = fs.readFileSync('lint.log', 'utf8');
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `### âŒ Lint Failed\n\`\`\`\n${log}\n\`\`\``
            });


  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.5.0

      - name: Install dependencies
        run: pnpm install

      - name: Run tests
        run: |
          cd packages/assignment-6
          pnpm -F assignment-6 test:with_coverage
          ls -la
      - name: List coverage directory
        run: ls -la coverage

      - name: Post test results comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.TOKEN_FOR_CI }}
          script: |
            const fs = require('fs');
            const path = "packages/assignment-6/coverage/coverage-summary.json";
            let message = ``;
            const coverage = JSON.parse(fs.readFileSync(path, 'utf8'));          
            const { total } = coverage;
            message += `
            - ë¼ì¸ ì»¤ë²„ë¦¬ì§€: ${total.lines.pct}%
            - ë¸Œëœì¹˜ ì»¤ë²„ë¦¬ì§€: ${total.branches.pct}%
            - í•¨ìˆ˜ ì»¤ë²„ë¦¬ì§€: ${total.functions.pct}%
            - êµ¬ë¬¸ ì»¤ë²„ë¦¬ì§€: ${total.statements.pct}%`;
            message = '${{ job.status }}' === 'success' ?
              `## í…ŒìŠ¤íŠ¸ ì„±ê³µ âœ…\n### ì»¤ë²„ë¦¬ì§€ ê²°ê³¼\n${message}` :
              `## í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ :x:\n### ì»¤ë²„ë¦¬ì§€ ê²°ê³¼\n${message}`;
            // PRì— ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê¹€
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message,
            });

  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.5.0

      - name: Install dependencies
        run: pnpm install

      - name: Run Lighthouse
        run: pnpm -F assignment-6 lhci

      - name: Report Lighthouse
        if: success()
        uses: actions/github-script@v6
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.TOKEN_FOR_CI }}
        with:
          github-token: ${{ secrets.TOKEN_FOR_CI }}
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync("packages/assignment-6/lhci_reports/manifest.json", 'utf-8'))
            
            const summaries = results.map(({ summary }) => summary);
            
            const headers = Object.keys(summaries[0]);
            const headerRow = `| ${headers.join(' | ')} |`;
            const separatorRow = `| ${headers.map(() => '---').join(' | ')} |`;
          
            // í…Œì´ë¸”ì˜ ë°ì´í„° í–‰ ìƒì„±
            const dataRows = summaries.map(obj => {
              return `| ${headers.map(header => obj[header] * 100).join(' | ')} |`;
            })
              
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: [headerRow, separatorRow, ...dataRows].join('\n'),
            });

  assign_reviewer:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Assign random reviewer
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.TOKEN_FOR_CI }}
          script: |
            const teams = ["bbbjihan", "soojjung", "hhyewon", "hyesung99", "shiny1912"];
            const randomReviewer = teams[Math.floor(Math.random() * teams.length)];
            
            // PR ì½”ë©˜íŠ¸ ì‘ì„±
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `### ğŸ™ğŸ» ëœë¤ ë¦¬ë·° ìš”ì²­ \n@${randomReviewer} ë‹˜ì—ê²Œ ë¦¬ë·°ë¥¼ ìš”ì²­ë“œë¦½ë‹ˆë‹¤.`
            });
            
            // ë¦¬ë·°ì–´ í• ë‹¹
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                reviewers: [randomReviewer]
              });
              console.log(`Successfully assigned ${randomReviewer} as a reviewer.`);
            } catch (error) {
              console.error(`Failed to assign reviewer: ${error.message}`);
              // ë¦¬ë·°ì–´ í• ë‹¹ ì‹¤íŒ¨ ì‹œ ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ë¦¬ë·°ì–´ í• ë‹¹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë¦¬ë·°ì–´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.`
              });
            }
